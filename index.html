<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>공유 플레이리스트</title>
  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03);
      --text:#e6eef6;
    }
    body.light {
      --bg:#f4f6fb;--card:#ffffff;--accent:#7c3aed;--muted:#444;--glass:rgba(0,0,0,0.03);
      --text:#111;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);transition:background 0.3s,color 0.3s}
    header{padding:18px 24px;display:flex;align-items:center;gap:16px;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .container{max-width:1100px;margin:18px auto;padding:18px}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.2);transition:background 0.3s}
    .small{font-size:13px;color:var(--muted)}
    .auth{display:flex;flex-direction:column;gap:8px}
    .auth input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:transparent;color:inherit}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
    .submit-group{display:flex;gap:8px;align-items:center}
    textarea{width:100%;min-height:64px;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.1);color:inherit}
    .feed{display:flex;flex-direction:column;gap:12px}
    .post{padding:12px;border-radius:12px;background:var(--glass)}
    .post-header{display:flex;gap:12px;align-items:flex-start;margin-bottom:8px}
    .meta{min-width:120px}
    .post-content{flex:1}
    .title{font-weight:600}
    .desc{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center;margin-top:8px}
    .like,.dislike{padding:6px 8px;border-radius:8px;background:var(--glass);cursor:pointer;border:none}
    .counts{font-size:13px;color:var(--muted);margin-left:6px}
    .comment-section{margin-top:12px;padding-top:12px;border-top:1px solid var(--glass)}
    .comment-box{margin-bottom:8px}
    .comment-box input{width:70%;margin-right:8px}
    .comment-list{display:flex;flex-direction:column;gap:6px}
    .comment{padding:8px;border-radius:8px;background:rgba(255,255,255,0.05)}
    .reply-box{margin-top:6px;margin-left:20px}
    .reply-box input{width:70%;margin-right:8px}
    .best-list{display:flex;flex-direction:column;gap:8px}
    .best-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:var(--glass)}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:900px){.layout{grid-template-columns:1fr}.meta{min-width:unset}}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:16px">
      <h1>공유 플레이리스트</h1>
      <div class="small">Spotify / YouTube / SoundCloud / Apple Music 지원</div>
    </div>
    <button id="theme-toggle" class="btn ghost">🌙/☀️</button>
  </header>

  <div class="container">
    <div class="layout">
      <aside>
        <div class="card"><div id="user-panel"></div></div>
        <div style="height:12px"></div>
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">실시간 베스트</div>
          <div id="best" class="best-list small"></div>
        </div>
      </aside>

      <main>
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">플레이리스트 올리기</div>
          <div class="small">허용되는 URL: Spotify/YouTube/SoundCloud/Apple Music</div>
          <div style="height:8px"></div>
          <div id="submit-area"></div>
        </div>
        <div style="height:12px"></div>
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">전체 공유 목록</div>
          <div id="feed" class="feed"></div>
        </div>
      </main>
    </div>
    <footer>⚠️ 이 서비스는 <b>데모</b>입니다. 데이터는 브라우저 localStorage에만 저장됩니다.</footer>
  </div>

<script>
const PROVIDER_PATTERNS = [
  {name:'YouTube', pattern:/(?:youtube\.com\/playlist\?list=|youtu\.be\/).*?/i},
  {name:'Spotify', pattern:/(?:open\.spotify\.com\/playlist\/|spotify:playlist:)/i},
  {name:'SoundCloud', pattern:/soundcloud\.com\/.+\/sets\//i},
  {name:'AppleMusic', pattern:/music\.apple\.com\/.+\/playlist\//i}
];
function storage(key,v){if(v===undefined)return JSON.parse(localStorage.getItem(key)||'null');localStorage.setItem(key,JSON.stringify(v));}
if(!storage('ps_users'))storage('ps_users',{});
if(!storage('ps_posts'))storage('ps_posts',[]);
let STATE={user:null};
function escapeHtml(str){return str.replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
function escapeAttr(str){return str.replace(/"/g,'&quot;');}

function renderUserPanel(){
  const el=document.getElementById('user-panel');el.innerHTML='';
  if(STATE.user){
    el.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(STATE.user)}</strong><div class="small">로그인 상태</div></div><button id="logout" class="btn ghost">로그아웃</button></div>`;
    document.getElementById('logout').onclick=()=>{STATE.user=null;localStorage.removeItem('ps_session');renderUserPanel();renderSubmitArea();};
  }else{
    el.innerHTML=`<div class="auth">
      <input id="auth-user" placeholder="아이디" />
      <input id="auth-pass" placeholder="비밀번호" type="password"/>
      <div style="display:flex;gap:8px"><button id="login" class="btn">로그인</button><button id="signup" class="btn ghost">회원가입</button></div>
      <div class="small">(데모) 비밀번호는 암호화 없이 저장됩니다.</div>
    </div>`;
    document.getElementById('signup').onclick=signup;
    document.getElementById('login').onclick=login;
  }
}
function signup(){
  const u=document.getElementById('auth-user').value.trim();
  const p=document.getElementById('auth-pass').value;
  if(!u||!p){alert('아이디/비밀번호 입력');return}
  const users=storage('ps_users')||{};
  if(users[u]){alert('이미 존재하는 아이디');return}
  users[u]={password:btoa(p)};storage('ps_users',users);
  alert('회원가입 완료. 로그인하세요.');
}
function login(){
  const u=document.getElementById('auth-user').value.trim();
  const p=document.getElementById('auth-pass').value;
  const users=storage('ps_users')||{};
  if(!users[u]||users[u].password!==btoa(p)){alert('아이디/비밀번호 오류');return}
  STATE.user=u;localStorage.setItem('ps_session',u);
  renderUserPanel();renderSubmitArea();renderFeed();
}
if(localStorage.getItem('ps_session'))STATE.user=localStorage.getItem('ps_session');
renderUserPanel();

function renderSubmitArea(){
  const area=document.getElementById('submit-area');
  if(!STATE.user){area.innerHTML='<div class="small">업로드하려면 로그인하세요.</div>';return}
  area.innerHTML=`<input id="title" placeholder="제목" /><div style="height:8px"></div>
  <input id="link" placeholder="링크" /><div style="height:8px"></div>
  <textarea id="description" placeholder="설명"></textarea><div style="height:8px"></div>
  <div class="submit-group"><button id="post-btn" class="btn">업로드</button><div class="small" id="post-msg"></div></div>`;
  document.getElementById('post-btn').onclick=handlePost;
}
renderSubmitArea();

function detectProvider(url){try{for(const p of PROVIDER_PATTERNS){if(p.pattern.test(url))return p.name}}catch(e){}return null;}
function handlePost(){
  const title=document.getElementById('title').value.trim();
  const link=document.getElementById('link').value.trim();
  const desc=document.getElementById('description').value.trim();
  const msg=document.getElementById('post-msg');msg.textContent='';
  if(!title||!link){msg.textContent='제목/링크 필요';return}
  const provider=detectProvider(link);if(!provider){msg.textContent='허용되지 않은 링크';return}
  const posts=storage('ps_posts')||[];
  const id='p_'+Date.now();
  posts.unshift({id,title,link,desc,provider,owner:STATE.user,likes:0,dislikes:0,comments:[],votes:{}});
  storage('ps_posts',posts);
  document.getElementById('title').value='';document.getElementById('link').value='';document.getElementById('description').value='';
  msg.textContent='업로드 완료';renderFeed();renderBest();
}
function toggleLike(id,isLike){
  if(!STATE.user){alert('로그인 필요');return;}
  const posts=storage('ps_posts')||[];const p=posts.find(x=>x.id===id);if(!p)return;
  
  // 사용자별 투표 기록 초기화
  if(!p.votes)p.votes={};
  
  const currentVote=p.votes[STATE.user]; // 'like', 'dislike', 또는 undefined
  
  if(currentVote===undefined){
    // 처음 투표하는 경우
    if(isLike){p.likes++;p.votes[STATE.user]='like';}
    else{p.dislikes++;p.votes[STATE.user]='dislike';}
  }else if(currentVote==='like'){
    if(isLike){
      // 좋아요 취소
      p.likes--;delete p.votes[STATE.user];
    }else{
      // 좋아요→싫어요 변경
      p.likes--;p.dislikes++;p.votes[STATE.user]='dislike';
    }
  }else if(currentVote==='dislike'){
    if(!isLike){
      // 싫어요 취소
      p.dislikes--;delete p.votes[STATE.user];
    }else{
      // 싫어요→좋아요 변경
      p.dislikes--;p.likes++;p.votes[STATE.user]='like';
    }
  }
  
  storage('ps_posts',posts);renderFeed();renderBest();
}
function addComment(pid,text){
  if(!STATE.user){alert('로그인 필요');return}
  if(!text.trim())return;
  const posts=storage('ps_posts')||[];const p=posts.find(x=>x.id===pid);if(!p)return;
  p.comments.push({user:STATE.user,text,replies:[]});
  storage('ps_posts',posts);renderFeed();
}
function addReply(pid,cidx,text){
  if(!STATE.user){alert('로그인 필요');return}
  if(!text.trim())return;
  const posts=storage('ps_posts')||[];const p=posts.find(x=>x.id===pid);if(!p)return;
  p.comments[cidx].replies.push({user:STATE.user,text});
  storage('ps_posts',posts);renderFeed();
}
function deletePost(id){
  console.log('deletePost 호출됨, id:', id, 'user:', STATE.user);
  if(!STATE.user){alert('로그인 필요');return;}
  const posts=storage('ps_posts')||[];
  console.log('전체 게시물:', posts.length, '개');
  const postIndex=posts.findIndex(x=>x.id===id);
  console.log('게시물 인덱스:', postIndex);
  if(postIndex===-1){alert('게시물을 찾을 수 없습니다.');return;}
  const post=posts[postIndex];
  console.log('게시물 상세:', {
    id: post.id,
    title: post.title,
    owner: post.owner,
    ownerType: typeof post.owner
  });
  console.log('현재 사용자:', STATE.user, 'type:', typeof STATE.user);
  console.log('소유자 비교:', post.owner, '===', STATE.user, '결과:', post.owner===STATE.user);
  
  if(post.owner!==STATE.user){
    alert('자신의 게시물만 삭제할 수 있습니다. 소유자:'+post.owner+', 현재사용자:'+STATE.user);
    return;
  }
  
  console.log('소유자 확인 통과, confirm 대화상자 표시');
  if(confirm(`"${post.title}" 게시물을 삭제하시겠습니까?`)){
    console.log('사용자가 삭제 확인함');
    posts.splice(postIndex,1);
    storage('ps_posts',posts);
    console.log('삭제 후 게시물 수:', posts.length);
    renderFeed();
    renderBest();
    alert('게시물이 삭제되었습니다.');
  } else {
    console.log('사용자가 삭제 취소함');
  }
}
function renderFeed(){
  const feed=document.getElementById('feed');feed.innerHTML='';
  const posts=storage('ps_posts')||[];
  if(posts.length===0){feed.innerHTML='<div class=small>아직 공유 없음</div>';return}
  for(const post of posts){
    const node=document.createElement('div');node.className='post';
    
    // 상단 헤더 (제목, 작성자 정보, 좋아요/싫어요)
    const header=document.createElement('div');header.className='post-header';
    const meta=document.createElement('div');meta.className='meta';
    meta.innerHTML=`<div class=title>${escapeHtml(post.title)}</div><div class=small>by ${escapeHtml(post.owner)} · ${escapeHtml(post.provider)}</div>`;
    
    const content=document.createElement('div');content.className='post-content';
    content.innerHTML=`<a href="${escapeAttr(post.link)}" target=_blank>${escapeHtml(post.link)}</a>`;
    if(post.desc){content.innerHTML+=`<div class=small style="margin-top:4px">${escapeHtml(post.desc)}</div>`}
    
    const actions=document.createElement('div');actions.className='actions';
    const like=document.createElement('button');like.className='like';
    const dislike=document.createElement('button');dislike.className='dislike';
    
    // 현재 사용자의 투표 상태 확인
    const userVote=STATE.user&&post.votes?post.votes[STATE.user]:null;
    
    // 좋아요 버튼 설정
    like.textContent=userVote==='like'?'👍✓':'👍';
    like.style.background=userVote==='like'?'var(--accent)':'var(--glass)';
    like.onclick=()=>toggleLike(post.id,true);
    
    // 싫어요 버튼 설정  
    dislike.textContent=userVote==='dislike'?'👎✓':'👎';
    dislike.style.background=userVote==='dislike'?'#dc2626':'var(--glass)';
    dislike.onclick=()=>toggleLike(post.id,false);
    
    const counts=document.createElement('div');counts.className='counts';counts.textContent=`${post.likes}/${post.dislikes}`;
    actions.append(like,dislike,counts);
    
    // 삭제 버튼 (자신의 게시물인 경우에만)
    if(STATE.user===post.owner){
      console.log('삭제 버튼 생성 중, 게시물 ID:', post.id, '소유자:', post.owner);
      const del=document.createElement('button');
      del.className='btn ghost';
      del.textContent='삭제';
      del.style.marginLeft='8px';
      del.onclick=function(){
        console.log('삭제 버튼 클릭됨');
        deletePost(post.id);
      };
      actions.append(del);
    }
    
    content.appendChild(actions);
    header.append(meta,content);
    
    // 댓글 섹션 (별도 섹션으로 분리)
    const commentSection=document.createElement('div');commentSection.className='comment-section';
    
    const commentBox=document.createElement('div');commentBox.className='comment-box';
    const ci=document.createElement('input');ci.placeholder='댓글 달기...';
    const cb=document.createElement('button');cb.className='btn ghost';cb.textContent='댓글';cb.onclick=()=>{addComment(post.id,ci.value);ci.value=''};
    commentBox.append(ci,cb);
    
    const cl=document.createElement('div');cl.className='comment-list';
    post.comments.forEach((c,idx)=>{
      const cnode=document.createElement('div');cnode.className='comment small';
      cnode.innerHTML=`<strong>${escapeHtml(c.user)}</strong> ${escapeHtml(c.text)}`;
      if(STATE.user){
        const rb=document.createElement('div');rb.className='reply-box';
        const ri=document.createElement('input');ri.placeholder='대댓글...';
        const rbtn=document.createElement('button');rbtn.className='btn ghost';rbtn.textContent='↩';rbtn.onclick=()=>{addReply(post.id,idx,ri.value);ri.value=''};
        rb.append(ri,rbtn);cnode.appendChild(rb);
      }
      if(c.replies){c.replies.forEach(r=>{const rn=document.createElement('div');rn.className='small';rn.style.marginLeft='20px';rn.innerHTML=`↳ <strong>${escapeHtml(r.user)}</strong> ${escapeHtml(r.text)}`;cnode.appendChild(rn);});}
      cl.appendChild(cnode);
    });
    
    commentSection.append(commentBox,cl);
    node.append(header,commentSection);
    feed.appendChild(node);
  }
}
function renderBest(){
  const best=document.getElementById('best');best.innerHTML='';
  const posts=storage('ps_posts')||[];
  posts.sort((a,b)=>(b.likes-b.dislikes)-(a.likes-a.dislikes));
  posts.slice(0,5).forEach(p=>{const d=document.createElement('div');d.className='best-item';d.textContent=`${p.title} (${p.likes}👍)`;best.appendChild(d);});
}
renderFeed();renderBest();

// 테마 토글
const themeBtn=document.getElementById('theme-toggle');
function applyTheme(){document.body.classList.toggle('light',localStorage.getItem('theme')==='light');}
themeBtn.onclick=()=>{const cur=localStorage.getItem('theme')==='light'?'dark':'light';localStorage.setItem('theme',cur);applyTheme();}
applyTheme();
</script>
</body>
</html>
