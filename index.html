<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê³µìœ  í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</title>
  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03);
      --text:#e6eef6;
    }
    body.light {
      --bg:#f4f6fb;--card:#ffffff;--accent:#7c3aed;--muted:#444;--glass:rgba(0,0,0,0.03);
      --text:#111;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);transition:background 0.3s,color 0.3s}
    header{padding:18px 24px;display:flex;align-items:center;gap:16px;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .container{max-width:1100px;margin:18px auto;padding:18px}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.2);transition:background 0.3s}
    .small{font-size:13px;color:var(--muted)}
    .auth{display:flex;flex-direction:column;gap:8px}
    .auth input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:transparent;color:inherit}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--muted);color:var(--text)}
    .submit-group{display:flex;gap:8px;align-items:center}
    textarea{width:100%;min-height:64px;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.1);color:inherit}
    .feed{display:flex;flex-direction:column;gap:12px}
    .post{padding:12px;border-radius:12px;background:var(--glass)}
    .post-header{display:flex;gap:12px;align-items:flex-start;margin-bottom:8px}
    .meta{min-width:120px}
    .post-content{flex:1}
    .title{font-weight:600}
    .desc{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center;margin-top:8px}
    .like,.dislike{padding:6px 8px;border-radius:8px;background:var(--glass);cursor:pointer;border:none}
    .counts{font-size:13px;color:var(--muted);margin-left:6px}
    .comment-section{margin-top:12px;padding-top:12px;border-top:1px solid var(--glass)}
    .comment-box{margin-bottom:8px}
    .comment-box input{width:70%;margin-right:8px}
    .comment-list{display:flex;flex-direction:column;gap:6px}
    .comment{padding:8px;border-radius:8px;background:rgba(255,255,255,0.05)}
    .reply-box{margin-top:6px;margin-left:20px}
    .reply-box input{width:70%;margin-right:8px}
    .best-list{display:flex;flex-direction:column;gap:8px}
    .best-item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:var(--glass)}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:900px){.layout{grid-template-columns:1fr}.meta{min-width:unset}}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:16px">
      <h1>ê³µìœ  í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h1>
      <div class="small">Spotify / YouTube / SoundCloud / Apple Music ì§€ì›</div>
    </div>
    <button id="theme-toggle" class="btn ghost">ğŸŒ™/â˜€ï¸</button>
  </header>

  <div class="container">
    <div class="layout">
      <aside>
        <div class="card"><div id="user-panel"></div></div>
        <div style="height:12px"></div>
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">ì‹¤ì‹œê°„ ë² ìŠ¤íŠ¸</div>
          <div id="best" class="best-list small"></div>
        </div>
      </aside>

      <main>
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì˜¬ë¦¬ê¸°</div>
          <div class="small">í—ˆìš©ë˜ëŠ” URL: Spotify/YouTube/SoundCloud/Apple Music</div>
          <div style="height:8px"></div>
          <div id="submit-area"></div>
        </div>
        <div style="height:12px"></div>
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">ì „ì²´ ê³µìœ  ëª©ë¡</div>
          <div id="feed" class="feed"></div>
        </div>
      </main>
    </div>
    <footer>âš ï¸ ì´ ì„œë¹„ìŠ¤ëŠ” <b>ë°ëª¨</b>ì…ë‹ˆë‹¤. ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</footer>
  </div>

<script>
const PROVIDER_PATTERNS = [
  {name:'YouTube', pattern:/(?:youtube\.com\/playlist\?list=|youtu\.be\/).*?/i},
  {name:'Spotify', pattern:/(?:open\.spotify\.com\/playlist\/|spotify:playlist:)/i},
  {name:'SoundCloud', pattern:/soundcloud\.com\/.+\/sets\//i},
  {name:'AppleMusic', pattern:/music\.apple\.com\/.+\/playlist\//i}
];
function storage(key,v){if(v===undefined)return JSON.parse(localStorage.getItem(key)||'null');localStorage.setItem(key,JSON.stringify(v));}
if(!storage('ps_users'))storage('ps_users',{});
if(!storage('ps_posts'))storage('ps_posts',[]);
let STATE={user:null};
function escapeHtml(str){return str.replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
function escapeAttr(str){return str.replace(/"/g,'&quot;');}

function renderUserPanel(){
  const el=document.getElementById('user-panel');el.innerHTML='';
  if(STATE.user){
    el.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(STATE.user)}</strong><div class="small">ë¡œê·¸ì¸ ìƒíƒœ</div></div><button id="logout" class="btn ghost">ë¡œê·¸ì•„ì›ƒ</button></div>`;
    document.getElementById('logout').onclick=()=>{STATE.user=null;localStorage.removeItem('ps_session');renderUserPanel();renderSubmitArea();};
  }else{
    el.innerHTML=`<div class="auth">
      <input id="auth-user" placeholder="ì•„ì´ë””" />
      <input id="auth-pass" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password"/>
      <div style="display:flex;gap:8px"><button id="login" class="btn">ë¡œê·¸ì¸</button><button id="signup" class="btn ghost">íšŒì›ê°€ì…</button></div>
      <div class="small">(ë°ëª¨) ë¹„ë°€ë²ˆí˜¸ëŠ” ì•”í˜¸í™” ì—†ì´ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>`;
    document.getElementById('signup').onclick=signup;
    document.getElementById('login').onclick=login;
  }
}
function signup(){
  const u=document.getElementById('auth-user').value.trim();
  const p=document.getElementById('auth-pass').value;
  if(!u||!p){alert('ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥');return}
  const users=storage('ps_users')||{};
  if(users[u]){alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””');return}
  users[u]={password:btoa(p)};storage('ps_users',users);
  alert('íšŒì›ê°€ì… ì™„ë£Œ. ë¡œê·¸ì¸í•˜ì„¸ìš”.');
}
function login(){
  const u=document.getElementById('auth-user').value.trim();
  const p=document.getElementById('auth-pass').value;
  const users=storage('ps_users')||{};
  if(!users[u]||users[u].password!==btoa(p)){alert('ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');return}
  STATE.user=u;localStorage.setItem('ps_session',u);
  renderUserPanel();renderSubmitArea();renderFeed();
}
if(localStorage.getItem('ps_session'))STATE.user=localStorage.getItem('ps_session');
renderUserPanel();

function renderSubmitArea(){
  const area=document.getElementById('submit-area');
  if(!STATE.user){area.innerHTML='<div class="small">ì—…ë¡œë“œí•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</div>';return}
  area.innerHTML=`<input id="title" placeholder="ì œëª©" /><div style="height:8px"></div>
  <input id="link" placeholder="ë§í¬" /><div style="height:8px"></div>
  <textarea id="description" placeholder="ì„¤ëª…"></textarea><div style="height:8px"></div>
  <div class="submit-group"><button id="post-btn" class="btn">ì—…ë¡œë“œ</button><div class="small" id="post-msg"></div></div>`;
  document.getElementById('post-btn').onclick=handlePost;
}
renderSubmitArea();

function detectProvider(url){try{for(const p of PROVIDER_PATTERNS){if(p.pattern.test(url))return p.name}}catch(e){}return null;}
function handlePost(){
  const title=document.getElementById('title').value.trim();
  const link=document.getElementById('link').value.trim();
  const desc=document.getElementById('description').value.trim();
  const msg=document.getElementById('post-msg');msg.textContent='';
  if(!title||!link){msg.textContent='ì œëª©/ë§í¬ í•„ìš”';return}
  const provider=detectProvider(link);if(!provider){msg.textContent='í—ˆìš©ë˜ì§€ ì•Šì€ ë§í¬';return}
  const posts=storage('ps_posts')||[];
  const id='p_'+Date.now();
  posts.unshift({id,title,link,desc,provider,owner:STATE.user,likes:0,dislikes:0,comments:[],votes:{}});
  storage('ps_posts',posts);
  document.getElementById('title').value='';document.getElementById('link').value='';document.getElementById('description').value='';
  msg.textContent='ì—…ë¡œë“œ ì™„ë£Œ';renderFeed();renderBest();
}
function toggleLike(id,isLike){
  if(!STATE.user){alert('ë¡œê·¸ì¸ í•„ìš”');return;}
  const posts=storage('ps_posts')||[];const p=posts.find(x=>x.id===id);if(!p)return;
  
  // ì‚¬ìš©ìë³„ íˆ¬í‘œ ê¸°ë¡ ì´ˆê¸°í™”
  if(!p.votes)p.votes={};
  
  const currentVote=p.votes[STATE.user]; // 'like', 'dislike', ë˜ëŠ” undefined
  
  if(currentVote===undefined){
    // ì²˜ìŒ íˆ¬í‘œí•˜ëŠ” ê²½ìš°
    if(isLike){p.likes++;p.votes[STATE.user]='like';}
    else{p.dislikes++;p.votes[STATE.user]='dislike';}
  }else if(currentVote==='like'){
    if(isLike){
      // ì¢‹ì•„ìš” ì·¨ì†Œ
      p.likes--;delete p.votes[STATE.user];
    }else{
      // ì¢‹ì•„ìš”â†’ì‹«ì–´ìš” ë³€ê²½
      p.likes--;p.dislikes++;p.votes[STATE.user]='dislike';
    }
  }else if(currentVote==='dislike'){
    if(!isLike){
      // ì‹«ì–´ìš” ì·¨ì†Œ
      p.dislikes--;delete p.votes[STATE.user];
    }else{
      // ì‹«ì–´ìš”â†’ì¢‹ì•„ìš” ë³€ê²½
      p.dislikes--;p.likes++;p.votes[STATE.user]='like';
    }
  }
  
  storage('ps_posts',posts);renderFeed();renderBest();
}
function addComment(pid,text){
  if(!STATE.user){alert('ë¡œê·¸ì¸ í•„ìš”');return}
  if(!text.trim())return;
  const posts=storage('ps_posts')||[];const p=posts.find(x=>x.id===pid);if(!p)return;
  p.comments.push({user:STATE.user,text,replies:[]});
  storage('ps_posts',posts);renderFeed();
}
function addReply(pid,cidx,text){
  if(!STATE.user){alert('ë¡œê·¸ì¸ í•„ìš”');return}
  if(!text.trim())return;
  const posts=storage('ps_posts')||[];const p=posts.find(x=>x.id===pid);if(!p)return;
  p.comments[cidx].replies.push({user:STATE.user,text});
  storage('ps_posts',posts);renderFeed();
}
function deletePost(id){
  console.log('deletePost í˜¸ì¶œë¨, id:', id, 'user:', STATE.user);
  if(!STATE.user){alert('ë¡œê·¸ì¸ í•„ìš”');return;}
  const posts=storage('ps_posts')||[];
  console.log('ì „ì²´ ê²Œì‹œë¬¼:', posts.length, 'ê°œ');
  const postIndex=posts.findIndex(x=>x.id===id);
  console.log('ê²Œì‹œë¬¼ ì¸ë±ìŠ¤:', postIndex);
  if(postIndex===-1){alert('ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');return;}
  const post=posts[postIndex];
  console.log('ê²Œì‹œë¬¼ ìƒì„¸:', {
    id: post.id,
    title: post.title,
    owner: post.owner,
    ownerType: typeof post.owner
  });
  console.log('í˜„ì¬ ì‚¬ìš©ì:', STATE.user, 'type:', typeof STATE.user);
  console.log('ì†Œìœ ì ë¹„êµ:', post.owner, '===', STATE.user, 'ê²°ê³¼:', post.owner===STATE.user);
  
  if(post.owner!==STATE.user){
    alert('ìì‹ ì˜ ê²Œì‹œë¬¼ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì†Œìœ ì:'+post.owner+', í˜„ì¬ì‚¬ìš©ì:'+STATE.user);
    return;
  }
  
  console.log('ì†Œìœ ì í™•ì¸ í†µê³¼, confirm ëŒ€í™”ìƒì í‘œì‹œ');
  if(confirm(`"${post.title}" ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
    console.log('ì‚¬ìš©ìê°€ ì‚­ì œ í™•ì¸í•¨');
    posts.splice(postIndex,1);
    storage('ps_posts',posts);
    console.log('ì‚­ì œ í›„ ê²Œì‹œë¬¼ ìˆ˜:', posts.length);
    renderFeed();
    renderBest();
    alert('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  } else {
    console.log('ì‚¬ìš©ìê°€ ì‚­ì œ ì·¨ì†Œí•¨');
  }
}
function renderFeed(){
  const feed=document.getElementById('feed');feed.innerHTML='';
  const posts=storage('ps_posts')||[];
  if(posts.length===0){feed.innerHTML='<div class=small>ì•„ì§ ê³µìœ  ì—†ìŒ</div>';return}
  for(const post of posts){
    const node=document.createElement('div');node.className='post';
    
    // ìƒë‹¨ í—¤ë” (ì œëª©, ì‘ì„±ì ì •ë³´, ì¢‹ì•„ìš”/ì‹«ì–´ìš”)
    const header=document.createElement('div');header.className='post-header';
    const meta=document.createElement('div');meta.className='meta';
    meta.innerHTML=`<div class=title>${escapeHtml(post.title)}</div><div class=small>by ${escapeHtml(post.owner)} Â· ${escapeHtml(post.provider)}</div>`;
    
    const content=document.createElement('div');content.className='post-content';
    content.innerHTML=`<a href="${escapeAttr(post.link)}" target=_blank>${escapeHtml(post.link)}</a>`;
    if(post.desc){content.innerHTML+=`<div class=small style="margin-top:4px">${escapeHtml(post.desc)}</div>`}
    
    const actions=document.createElement('div');actions.className='actions';
    const like=document.createElement('button');like.className='like';
    const dislike=document.createElement('button');dislike.className='dislike';
    
    // í˜„ì¬ ì‚¬ìš©ìì˜ íˆ¬í‘œ ìƒíƒœ í™•ì¸
    const userVote=STATE.user&&post.votes?post.votes[STATE.user]:null;
    
    // ì¢‹ì•„ìš” ë²„íŠ¼ ì„¤ì •
    like.textContent=userVote==='like'?'ğŸ‘âœ“':'ğŸ‘';
    like.style.background=userVote==='like'?'var(--accent)':'var(--glass)';
    like.onclick=()=>toggleLike(post.id,true);
    
    // ì‹«ì–´ìš” ë²„íŠ¼ ì„¤ì •  
    dislike.textContent=userVote==='dislike'?'ğŸ‘âœ“':'ğŸ‘';
    dislike.style.background=userVote==='dislike'?'#dc2626':'var(--glass)';
    dislike.onclick=()=>toggleLike(post.id,false);
    
    const counts=document.createElement('div');counts.className='counts';counts.textContent=`${post.likes}/${post.dislikes}`;
    actions.append(like,dislike,counts);
    
    // ì‚­ì œ ë²„íŠ¼ (ìì‹ ì˜ ê²Œì‹œë¬¼ì¸ ê²½ìš°ì—ë§Œ)
    if(STATE.user===post.owner){
      console.log('ì‚­ì œ ë²„íŠ¼ ìƒì„± ì¤‘, ê²Œì‹œë¬¼ ID:', post.id, 'ì†Œìœ ì:', post.owner);
      const del=document.createElement('button');
      del.className='btn ghost';
      del.textContent='ì‚­ì œ';
      del.style.marginLeft='8px';
      del.onclick=function(){
        console.log('ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨');
        deletePost(post.id);
      };
      actions.append(del);
    }
    
    content.appendChild(actions);
    header.append(meta,content);
    
    // ëŒ“ê¸€ ì„¹ì…˜ (ë³„ë„ ì„¹ì…˜ìœ¼ë¡œ ë¶„ë¦¬)
    const commentSection=document.createElement('div');commentSection.className='comment-section';
    
    const commentBox=document.createElement('div');commentBox.className='comment-box';
    const ci=document.createElement('input');ci.placeholder='ëŒ“ê¸€ ë‹¬ê¸°...';
    const cb=document.createElement('button');cb.className='btn ghost';cb.textContent='ëŒ“ê¸€';cb.onclick=()=>{addComment(post.id,ci.value);ci.value=''};
    commentBox.append(ci,cb);
    
    const cl=document.createElement('div');cl.className='comment-list';
    post.comments.forEach((c,idx)=>{
      const cnode=document.createElement('div');cnode.className='comment small';
      cnode.innerHTML=`<strong>${escapeHtml(c.user)}</strong> ${escapeHtml(c.text)}`;
      if(STATE.user){
        const rb=document.createElement('div');rb.className='reply-box';
        const ri=document.createElement('input');ri.placeholder='ëŒ€ëŒ“ê¸€...';
        const rbtn=document.createElement('button');rbtn.className='btn ghost';rbtn.textContent='â†©';rbtn.onclick=()=>{addReply(post.id,idx,ri.value);ri.value=''};
        rb.append(ri,rbtn);cnode.appendChild(rb);
      }
      if(c.replies){c.replies.forEach(r=>{const rn=document.createElement('div');rn.className='small';rn.style.marginLeft='20px';rn.innerHTML=`â†³ <strong>${escapeHtml(r.user)}</strong> ${escapeHtml(r.text)}`;cnode.appendChild(rn);});}
      cl.appendChild(cnode);
    });
    
    commentSection.append(commentBox,cl);
    node.append(header,commentSection);
    feed.appendChild(node);
  }
}
function renderBest(){
  const best=document.getElementById('best');best.innerHTML='';
  const posts=storage('ps_posts')||[];
  posts.sort((a,b)=>(b.likes-b.dislikes)-(a.likes-a.dislikes));
  posts.slice(0,5).forEach(p=>{const d=document.createElement('div');d.className='best-item';d.textContent=`${p.title} (${p.likes}ğŸ‘)`;best.appendChild(d);});
}
renderFeed();renderBest();

// í…Œë§ˆ í† ê¸€
const themeBtn=document.getElementById('theme-toggle');
function applyTheme(){document.body.classList.toggle('light',localStorage.getItem('theme')==='light');}
themeBtn.onclick=()=>{const cur=localStorage.getItem('theme')==='light'?'dark':'light';localStorage.setItem('theme',cur);applyTheme();}
applyTheme();
</script>
</body>
</html>
